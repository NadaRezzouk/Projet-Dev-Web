<%- include('partials/header') %>

<!-- Page Carte des Salles -->
<div class="container-fluid px-0">
  <!-- Carte -->
  <section id="mapView" class="dashboard-section">
    <div class="section-header">
      <div class="section-title">
        <div class="title-icon"><i class="fas fa-map-marked-alt"></i></div>
        <div><h2>Carte des salles</h2><p class="section-subtitle">Explorez les salles disponibles</p></div>
      </div>
    </div>

    <div class="map-section-wrapper">
      <div class="map-sidebar">
        <div class="map-sidebar-header">
          <h4><i class="fas fa-list me-2"></i>Salles disponibles</h4>
          <span class="rooms-count"><%= (rooms || []).length %> salles</span>
        </div>
        <div class="map-rooms-list">
          <% (rooms || []).forEach(function(room) { %>
            <div class="map-room-item" data-room-id="<%= room.id %>" data-lat="<%= room.lat %>" data-lng="<%= room.lng %>">
              <div class="map-room-image"><img src="<%= room.image %>" alt="<%= room.name %>"></div>
              <div class="map-room-info">
                <h5 class="map-room-name"><%= room.name %></h5>
                <div class="map-room-details"><span><i class="fas fa-map-marker-alt"></i> <%= room.wilaya %></span><span><i class="fas fa-users"></i> <%= room.capacity %></span></div>
                <div class="map-room-price"><%= parseInt(room.price || 0) %> DA<span>/jour</span></div>
              </div>
              <div class="map-room-action"><a href="/rooms/<%= room.id %>/book" class="btn-map-book" title="Réserver"><i class="fas fa-arrow-right"></i></a></div>
            </div>
          <% }); %>
        </div>
      </div>

      <div class="map-main">
        <div class="map-container-premium">
          <div id="map" style="height:100%;"></div>
          <div class="map-controls">
            <button class="map-control-btn" id="mapZoomIn" title="Zoom +"><i class="fas fa-plus"></i></button>
            <button class="map-control-btn" id="mapZoomOut" title="Zoom -"><i class="fas fa-minus"></i></button>
            <button class="map-control-btn" id="mapReset" title="Réinitialiser"><i class="fas fa-sync-alt"></i></button>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<%- include('partials/footer') %>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
/* Safe helper */
function setDisplayById(id, value) {
  const el = document.getElementById(id);
  if (el) el.style.display = value;
}

document.addEventListener('DOMContentLoaded', function () {
  // Move modals into body to avoid clipping if ancestor has transform/overflow
  document.querySelectorAll('.modal').forEach(function(modalEl) {
    if (modalEl.parentNode !== document.body) document.body.appendChild(modalEl);
  });

  // Map init (protected) - moved before navigation to fix refresh issue
  let map;
  const markers = {};
  const mapEl = document.getElementById('map');
  if (mapEl) {
    try {
      map = L.map('map', {
        zoomControl: false,
        fadeAnimation: true,
        zoomAnimation: true,
        markerZoomAnimation: true
      }).setView([36.7538, 3.0588], 10);

      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '© OpenStreetMap contributors © CARTO',
        maxZoom: 19,
        updateWhenIdle: false,
        updateWhenZooming: false
      }).addTo(map);

      // Force resize after initialization for better fluidity
      setTimeout(() => {
        map.invalidateSize();
      }, 100);

    } catch (e) {
      console.warn('Map init failed:', e);
    }
  }

  // Add markers safely
  <% (rooms || []).forEach(function(room) { %>
    <% if (room.lat != null && room.lng != null) { %>
      (function(){
        try {
          if (typeof L !== 'undefined' && map) {
            const icon = L.divIcon({ className: 'custom-map-marker', html: '<div class="marker-pin"><i class="fas fa-door-open"></i></div>', iconSize: [40,40], iconAnchor: [20,40], popupAnchor: [0,-40] });
            const m = L.marker([<%= room.lat %>, <%= room.lng %>], { icon }).bindPopup(`
              <div class="map-popup">
                <img src="<%= room.image %>" alt="<%= room.name %>">
                <div class="popup-content">
                  <h5><%= room.name %></h5>
                  <p class="popup-location"><i class="fas fa-map-marker-alt"></i> <%= room.wilaya %></p>
                  <p class="popup-price"><%= parseInt(room.price || 0) %> DA/jour</p>
                  <a href="/rooms/<%= room.id %>/book" class="popup-btn">Réserver</a>
                </div>
              </div>
            `, { className: 'custom-popup' }).addTo(map);
            markers['<%= room.id %>'] = m;
          }
        } catch (err) { console.warn('Marker error for room <%= room.id %>:', err); }
      })();
    <% } %>
  <% }); %>

  // Map/list interaction
  document.querySelectorAll('.map-room-item').forEach(item => {
    item.addEventListener('click', function() {
        const lat = parseFloat(this.dataset.lat), lng = parseFloat(this.dataset.lng), roomId = this.dataset.roomId;
        if (!isNaN(lat) && !isNaN(lng) && map) {
            // Animation en deux étapes : d'abord dézoomer, puis aller vers la salle
map.flyTo([lat, lng], 10, {
              duration: 1.2,
              easeLinearity: 0.25
            });
            
            map.once('moveend', function() {
                map.flyTo([lat, lng], 13, {
                  duration: 1.5,
                  easeLinearity: 0.25
                });

                map.once('moveend', function() {
                    if (markers[roomId]) markers[roomId].openPopup();
                });
            });
        }
        document.querySelectorAll('.map-room-item').forEach(i => i.classList.remove('active'));
        this.classList.add('active');
    });
  });

  document.getElementById('mapZoomIn')?.addEventListener('click', () => map && map.zoomIn());
  document.getElementById('mapZoomOut')?.addEventListener('click', () => map && map.zoomOut());
  document.getElementById('mapReset')?.addEventListener('click', () => map && map.setView([36.7538, 3.0588], 10));

  // Handle window resize for better fluidity
  window.addEventListener('resize', function() {
    if (map) {
      setTimeout(() => map.invalidateSize(), 100);
    }
  });

  // Force resize on load
  window.addEventListener('load', function() {
    if (map) {
      setTimeout(() => map.invalidateSize(), 200);
    }
  });
});
</script>

<!-- Styles pour les marqueurs et popups de la carte -->
<style>
.custom-map-marker {
    background: transparent;
}

.marker-pin {
    width: 40px;
    height: 40px;
    border-radius: 50% 50% 50% 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    transform: rotate(-45deg);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 16px rgba(102, 126, 234, 0.5);
    animation: marker-bounce 0.5s ease-out;
}

.marker-pin i {
    transform: rotate(45deg);
    color: white;
    font-size: 16px;
}

@keyframes marker-bounce {
    0%, 100% { transform: rotate(-45deg) translateY(0); }
    50% { transform: rotate(-45deg) translateY(-10px); }
}

.custom-popup .leaflet-popup-content-wrapper {
    background: rgba(15, 23, 42, 0.95);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    padding: 0;
    overflow: hidden;
}

.custom-popup .leaflet-popup-tip {
    background: rgba(15, 23, 42, 0.95);
}

.custom-popup .leaflet-popup-content {
    margin: 0;
    width: 250px !important;
}

.map-popup img {
    width: 100%;
    height: 120px;
    object-fit: cover;
}

.popup-content {
    padding: 1rem;
}

.popup-content h5 {
    font-family: 'Playfair Display', serif;
    font-size: 1rem;
    font-weight: 600;
    color: #ffffff;
    margin: 0 0 0.5rem;
}

.popup-location {
    font-size: 0.8rem;
    color: #94a3b8;
    margin: 0 0 0.25rem;
}

.popup-location i {
    color: #8b5cf6;
    margin-right: 0.25rem;
}

.popup-price {
    font-size: 1rem;
    font-weight: 700;
    color: #f59e0b;
    margin: 0 0 0.75rem;
}

.popup-btn {
    display: block;
    width: 100%;
    padding: 0.5rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white !important;
    text-decoration: none;
    text-align: center;
    border-radius: 8px;
    font-size: 0.85rem;
    font-weight: 600;
    transition: all 0.3s ease;
}

.popup-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.leaflet-popup-close-button {
    color: #94a3b8 !important;
    font-size: 20px !important;
    padding: 8px !important;
}

.leaflet-popup-close-button:hover {
    color: #ffffff !important;
}
</style>

<!-- Styles pour la carte -->
<style>
.map-container-premium {
    height: 100%;
    min-height: 400px;
}

/* Optimisations pour la fluidité */
.leaflet-container {
    background: rgba(15, 23, 42, 0.95) !important;
}

.leaflet-tile {
    will-change: transform;
}

.leaflet-marker-icon {
    will-change: transform;
}

.leaflet-popup {
    will-change: transform;
}
</style>