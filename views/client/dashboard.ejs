<%- include('../partials/header') %>

<!-- Dashboard Client -->
<div class="dashboard-wrapper">
  <!-- Sidebar Simple -->
  <aside class="dashboard-sidebar simple">
    <nav class="sidebar-nav">
      <ul class="nav-list">
        <li class="nav-item">
          <a class="nav-link active" href="#searchRooms" title="Rechercher">
            <i class="fas fa-search"></i>
            <span>Rechercher</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#mapView" title="Carte">
            <i class="fas fa-map-marked-alt"></i>
            <span>Carte</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#myBookings" title="Réservations">
            <i class="fas fa-calendar-alt"></i>
            <span>Réservations</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#myReviews" title="Mes avis">
            <i class="fas fa-star"></i>
            <span>Mes avis</span>
          </a>
        </li>
      </ul>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="dashboard-main">
<% 
  // Défensif : s'assurer que reviews et user existent
  const reviewsArr = Array.isArray(reviews) ? reviews : [];
  const currentUserId = user && (user.id || user.id === 0) ? String(user.id) : null;
  const userReviews = currentUserId ? reviewsArr.filter(r => String(r.userId) === currentUserId) : [];
%>

    <!-- Dashboard Header -->
    <header class="dashboard-header">
      <div class="header-content">
        <div class="header-title">
          <h1>Mon Espace <span class="gradient-text">Client</span></h1>
          <p class="header-subtitle">Gérez vos réservations et découvrez de nouvelles salles</p>
        </div>
        <div class="header-actions">
          <a href="/rooms" class="btn-header-action">
            <i class="fas fa-plus me-2"></i>Nouvelle réservation
          </a>
        </div>
      </div>

      <!-- Quick Stats -->
      <div class="quick-stats">
        <div class="quick-stat-card">
          <div class="stat-icon-wrapper purple"><i class="fas fa-door-open"></i></div>
          <div class="stat-content">
            <span class="stat-number"><%= (rooms || []).length %></span>
            <span class="stat-text">Salles disponibles</span>
          </div>
        </div>

        <div class="quick-stat-card">
          <div class="stat-icon-wrapper gold"><i class="fas fa-calendar-check"></i></div>
          <div class="stat-content">
            <span class="stat-number"><%= (currentBookings || []).length %></span>
            <span class="stat-text">Réservations actives</span>
          </div>
        </div>

        <div class="quick-stat-card">
          <div class="stat-icon-wrapper green"><i class="fas fa-star"></i></div>
          <div class="stat-content">
            <span class="stat-number"><%= userReviews.length %></span>
            <span class="stat-text">Avis publiés</span>
          </div>
        </div>
      </div>
    </header>

    <!-- Section Recherche -->
    <section id="searchRooms" class="dashboard-section">
      <div class="section-header">
        <div class="section-title">
          <div class="title-icon"><i class="fas fa-search"></i></div>
          <div>
            <h2>Rechercher une salle</h2>
            <p class="section-subtitle">Trouvez l'espace parfait pour vos besoins</p>
          </div>
        </div>
      </div>

      <!-- Filtres -->
      <div class="filter-card">
        <form id="searchForm" class="filter-form">
          <div class="filter-row">
            <div class="filter-group main-search">
              <label class="filter-label"><i class="fas fa-search me-2"></i>Recherche</label>
              <div class="input-wrapper">
                <input type="text" class="form-control premium-input" id="searchQuery" placeholder="Nom, description, équipements...">
                <span class="input-icon"><i class="fas fa-search"></i></span>
              </div>
            </div>
          </div>
          <div class="filter-row">
            <div class="filter-group">
              <label class="filter-label"><i class="fas fa-coins me-2"></i>Prix min (DA)</label>
              <input type="number" class="form-control premium-input" id="minPrice" min="0" placeholder="0">
            </div>
            <div class="filter-group">
              <label class="filter-label"><i class="fas fa-coins me-2"></i>Prix max (DA)</label>
              <input type="number" class="form-control premium-input" id="maxPrice" min="0" placeholder="∞">
            </div>
            <div class="filter-group">
              <label class="filter-label"><i class="fas fa-users me-2"></i>Capacité min</label>
              <input type="number" class="form-control premium-input" id="minCapacity" min="1" placeholder="1">
            </div>
            <div class="filter-group">
              <label class="filter-label"><i class="fas fa-calendar me-2"></i>Date</label>
              <input type="date" class="form-control premium-input" id="searchDate">
            </div>
          </div>
          <div class="filter-row equipment-filters">
            <span class="filter-label-inline"><i class="fas fa-tools me-2"></i>Équipements:</span>
            <div class="checkbox-group">
              <label class="premium-checkbox"><input type="checkbox" id="hasWifi" value="wifi"><span class="checkmark"></span><i class="fas fa-wifi"></i> WiFi</label>
              <label class="premium-checkbox"><input type="checkbox" id="hasProjector" value="projector"><span class="checkmark"></span><i class="fas fa-video"></i> Vidéoprojecteur</label>
              <label class="premium-checkbox"><input type="checkbox" id="hasAC" value="ac"><span class="checkmark"></span><i class="fas fa-snowflake"></i> Climatisation</label>
            </div>
          </div>
        </form>
      </div>

      <!-- Résultats -->
      <div class="results-header">
        <span class="results-count"><%= (rooms || []).length %> salles trouvées</span>
        <div class="view-toggle">
          <button class="view-btn active" data-view="grid"><i class="fas fa-th-large"></i></button>
          <button class="view-btn" data-view="list"><i class="fas fa-list"></i></button>
        </div>
      </div>

      <div class="rooms-grid" id="searchResults">
        <% (rooms || []).forEach(function(room) { %>
          <div class="premium-room-card room-card" data-aos="fade-up">
            <div class="room-card-image">
              <img src="<%= room.image %>" alt="<%= room.name %>">
              <div class="room-card-overlay">
                <button type="button" class="quick-view-btn btn-details" data-bs-toggle="modal" data-bs-target="#roomModal<%= room.id %>">
                  <i class="fas fa-eye"></i> Aperçu rapide
                </button>
              </div>
              <div class="room-badge"><i class="fas fa-star"></i> Premium</div>
              <div class="room-price-tag"><%= parseInt(room.price || 0) %> DA<span>/jour</span></div>
            </div>

            <div class="room-card-content">
              <h3 class="room-card-title"><%= room.name %></h3>
              <p class="room-card-desc"><%= room.description ? room.description.substring(0, 80) : '' %>...</p>
              <div class="room-card-features">
                <div class="feature"><i class="fas fa-users"></i><span><%= room.capacity %> pers.</span></div>
                <div class="feature"><i class="fas fa-map-marker-alt"></i><span><%= room.wilaya %></span></div>
              </div>
              <div class="room-card-actions">
                <button type="button" class="btn-details" data-bs-toggle="modal" data-bs-target="#roomModal<%= room.id %>">
                  <i class="fas fa-info-circle"></i> Détails
                </button>
                <a href="/rooms/<%= room.id %>/book" class="btn-book"><i class="fas fa-calendar-check"></i> Réserver</a>
              </div>
            </div>
          </div>
        <% }); %>
      </div>
    </section>

    <!-- Carte -->
    <section id="mapView" class="dashboard-section" style="display: none;">
      <div class="section-header">
        <div class="section-title">
          <div class="title-icon"><i class="fas fa-map-marked-alt"></i></div>
          <div><h2>Carte des salles</h2><p class="section-subtitle">Explorez les salles disponibles</p></div>
        </div>
      </div>

      <div class="map-section-wrapper">
        <div class="map-sidebar">
          <div class="map-sidebar-header">
            <h4><i class="fas fa-list me-2"></i>Salles disponibles</h4>
            <span class="rooms-count"><%= (rooms || []).length %> salles</span>
          </div>
          <div class="map-rooms-list">
            <% (rooms || []).forEach(function(room) { %>
              <div class="map-room-item" data-room-id="<%= room.id %>" data-lat="<%= room.lat %>" data-lng="<%= room.lng %>">
                <div class="map-room-image"><img src="<%= room.image %>" alt="<%= room.name %>"></div>
                <div class="map-room-info">
                  <h5 class="map-room-name"><%= room.name %></h5>
                  <div class="map-room-details"><span><i class="fas fa-map-marker-alt"></i> <%= room.wilaya %></span><span><i class="fas fa-users"></i> <%= room.capacity %></span></div>
                  <div class="map-room-price"><%= parseInt(room.price || 0) %> DA<span>/jour</span></div>
                </div>
                <div class="map-room-action"><a href="/rooms/<%= room.id %>/book" class="btn-map-book" title="Réserver"><i class="fas fa-arrow-right"></i></a></div>
              </div>
            <% }); %>
          </div>
        </div>

        <div class="map-main">
          <div class="map-container-premium">
            <div id="map" style="height:400px;"></div>
            <div class="map-controls">
              <button class="map-control-btn" id="mapZoomIn" title="Zoom +"><i class="fas fa-plus"></i></button>
              <button class="map-control-btn" id="mapZoomOut" title="Zoom -"><i class="fas fa-minus"></i></button>
              <button class="map-control-btn" id="mapReset" title="Réinitialiser"><i class="fas fa-sync-alt"></i></button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Mes Réservations -->
    <section id="myBookings" class="dashboard-section" style="display: none;">
      <div class="section-header">
        <div class="section-title"><div class="title-icon"><i class="fas fa-calendar-alt"></i></div><div><h2>Mes réservations</h2><p class="section-subtitle">Suivez et gérez vos réservations</p></div></div>
      </div>

      <div class="bookings-section">
        <h3 class="subsection-title"><span class="status-dot active"></span> Réservations en cours</h3>
        <div class="bookings-grid">
          <% if (currentBookings && currentBookings.length > 0) { %>
            <% currentBookings.forEach(function(booking) { %>
              <div class="booking-card active" data-aos="fade-up">
                <div class="booking-status"><span class="status-badge active"><i class="fas fa-clock"></i> En cours</span></div>
                <div class="booking-content">
                  <h4 class="booking-title"><%= booking.room.name %></h4>
                  <div class="booking-details">
                    <div class="booking-detail"><i class="fas fa-calendar"></i>
                      <div class="detail-content">
                        <span class="detail-label">Période</span>
                        <span class="detail-value"><%= new Date(booking.startDate).toLocaleDateString('fr-FR') %> - <%= new Date(booking.endDate).toLocaleDateString('fr-FR') %></span>
                      </div>
                    </div>
                    <div class="booking-detail"><i class="fas fa-users"></i>
                      <div class="detail-content"><span class="detail-label">Participants</span><span class="detail-value"><%= booking.participants %> personnes</span></div>
                    </div>
                    <div class="booking-detail"><i class="fas fa-coins"></i>
                      <div class="detail-content"><span class="detail-label">Prix</span><span class="detail-value price"><%= parseInt(booking.room.price || 0) %> DA/jour</span></div>
                    </div>
                    <div class="booking-detail"><i class="fas fa-map-marker-alt"></i>
                      <div class="detail-content"><span class="detail-label">Localisation</span><span class="detail-value"><%= booking.room.wilaya %></span></div>
                    </div>
                  </div>

                  <div class="booking-actions mt-3">
                    <% const hasReviewCurr = reviewsArr.find(function(r) { return r.bookingId === booking.id; }); %>
                    <% if (hasReviewCurr) { %>
                      <span class="badge bg-success"><i class="fas fa-check me-1"></i> Avis déposé</span>
                    <% } else { %>
                      <a href="/bookings/<%= booking.id %>/review" class="btn btn-warning btn-sm"><i class="fas fa-star me-1"></i> Laisser un avis</a>
                    <% } %>
                  </div>

                </div>
              </div>
            <% }); %>
          <% } else { %>
            <div class="empty-state">
              <div class="empty-icon"><i class="fas fa-calendar-times"></i></div>
              <h4>Aucune réservation en cours</h4>
              <p>Vous n'avez pas de réservation active pour le moment.</p>
              <a href="/rooms" class="btn-empty-action"><i class="fas fa-search me-2"></i>Trouver une salle</a>
            </div>
          <% } %>
        </div>
      </div>

      <!-- Réservations passées -->
      <div class="bookings-section past">
        <h3 class="subsection-title"><span class="status-dot past"></span> Réservations passées</h3>
        <div class="bookings-grid">
          <% if (pastBookings && pastBookings.length > 0) { %>
            <% pastBookings.forEach(function(booking) { %>
              <div class="booking-card past" data-aos="fade-up">
                <div class="booking-status"><span class="status-badge past"><i class="fas fa-check-circle"></i> Terminée</span></div>
                <div class="booking-content">
                  <h4 class="booking-title"><%= booking.room.name %></h4>
                  <div class="booking-details">
                    <div class="booking-detail"><i class="fas fa-calendar"></i>
                      <div class="detail-content"><span class="detail-label">Période</span><span class="detail-value"><%= new Date(booking.startDate).toLocaleDateString('fr-FR') %> - <%= new Date(booking.endDate).toLocaleDateString('fr-FR') %></span></div>
                    </div>
                    <div class="booking-detail"><i class="fas fa-users"></i>
                      <div class="detail-content"><span class="detail-label">Participants</span><span class="detail-value"><%= booking.participants %> personnes</span></div>
                    </div>
                    <div class="booking-detail"><i class="fas fa-coins"></i>
                      <div class="detail-content"><span class="detail-label">Prix</span><span class="detail-value"><%= parseInt(booking.room.price || 0) %> DA/jour</span></div>
                    </div>
                    <div class="booking-detail"><i class="fas fa-map-marker-alt"></i>
                      <div class="detail-content"><span class="detail-label">Localisation</span><span class="detail-value"><%= booking.room.wilaya %></span></div>
                    </div>
                  </div>

                  <div class="booking-actions mt-3">
                    <% const hasReviewPast = reviewsArr.find(function(r) { return r.bookingId === booking.id; }); %>
                    <% if (hasReviewPast) { %> 
                      <span class="badge bg-success"><i class="fas fa-check me-1"></i> Avis déposé</span>
                    <% } else { %>
                      <a href="/bookings/<%= booking.id %>/review" class="btn btn-warning btn-sm"><i class="fas fa-star me-1"></i> Laisser un avis</a>
                    <% } %>
                  </div>

                </div>
              </div>
            <% }); %>
          <% } else { %>
            <div class="empty-state small"><div class="empty-icon small"><i class="fas fa-history"></i></div><p>Aucune réservation passée</p></div>
          <% } %>
        </div>
      </div>
    </section>

    <!-- Mes Avis -->
    <section id="myReviews" class="dashboard-section" style="display: none;">
      <div class="section-header">
        <div class="section-title"><div class="title-icon"><i class="fas fa-star"></i></div><div><h2>Mes avis</h2><p class="section-subtitle">Vos retours d'expérience</p></div></div>
      </div>

      <div class="reviews-grid">
        <% if (userReviews && userReviews.length > 0) { %>
          <% userReviews.forEach(function(review) { %>
            <div class="review-card" data-aos="fade-up">
              <div class="review-header">
                <h4 class="review-room"><%= review.roomName || 'Salle' %></h4>
                <div class="review-rating">
                  <% for (let i = 0; i < 5; i++) { %>
                    <i class="fas fa-star <%= i < (parseInt(review.rating,10)||0) ? 'active' : '' %>"></i>
                  <% } %>
                </div>
              </div>
              <p class="review-text"><%= review.comment || '' %></p>
              <div class="review-footer"><span class="review-date"><i class="fas fa-calendar-alt me-2"></i><%= review.date ? (new Date(review.date)).toLocaleDateString('fr-FR') : '' %></span></div>
            </div>
          <% }); %>
        <% } else { %>
          <div class="empty-state"><div class="empty-icon"><i class="fas fa-comment-dots"></i></div><h4>Aucun avis publié</h4><p>Partagez votre expérience après votre première réservation!</p></div>
        <% } %>
      </div>
    </section>

  </main>
</div>

<!-- Modals (one per room) -->
<% (rooms || []).forEach(function(room) { %>
  <div class="modal fade premium-modal" id="roomModal<%= room.id %>" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-door-open me-2"></i><%= room.name %></h5>
          <button type="button" class="btn-close-premium" data-bs-dismiss="modal" aria-label="Close"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
          <div class="modal-room-layout">
            <div class="modal-room-image">
              <img src="<%= room.image %>" alt="<%= room.name %>">
              <div class="modal-price-badge"><%= parseInt(room.price || 0) %> DA<span>/jour</span></div>
            </div>
            <div class="modal-room-info">
              <h6 class="info-title"><i class="fas fa-list-ul me-2"></i>Caractéristiques</h6>
              <ul class="info-list">
                <li><i class="fas fa-users"></i><span>Capacité: <strong><%= room.capacity %> personnes</strong></span></li>
                <li><i class="fas fa-coins"></i><span>Prix: <strong><%= parseInt(room.price || 0) %> DA/jour</strong></span></li>
                <li><i class="fas fa-map-marker-alt"></i><span>Wilaya: <strong><%= room.wilaya %></strong></span></li>
              </ul>
              <h6 class="info-title mt-4"><i class="fas fa-tools me-2"></i>Équipements</h6>
              <div class="equipment-grid">
                <% (room.equipment || []).forEach(function(item) { %>
                  <div class="equipment-item"><i class="fas fa-check-circle"></i><span><%= item %></span></div>
                <% }); %>
              </div>
            </div>
          </div>
          <div class="modal-description"><h6 class="info-title"><i class="fas fa-align-left me-2"></i>Description</h6><p><%= room.description %></p></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-modal-secondary" data-bs-dismiss="modal"><i class="fas fa-times me-2"></i>Fermer</button>
          <a href="/rooms/<%= room.id %>/book" class="btn-modal-primary"><i class="fas fa-calendar-check me-2"></i>Réserver maintenant</a>
        </div>
      </div>
    </div>
  </div>
<% }); %>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
/* Safe helper */
function setDisplayById(id, value) {
  const el = document.getElementById(id);
  if (el) el.style.display = value;
}

document.addEventListener('DOMContentLoaded', function () {
  // Move modals into body to avoid clipping if ancestor has transform/overflow
  document.querySelectorAll('.modal').forEach(function(modalEl) {
    if (modalEl.parentNode !== document.body) document.body.appendChild(modalEl);
  });

  // Sidebar navigation
  const sidebarLinks = document.querySelectorAll('.dashboard-sidebar .nav-link');
  const mainSections = document.querySelectorAll('.dashboard-main section');
  function showSectionById(id) {
    mainSections.forEach(section => section.style.display = 'none');
    const target = document.getElementById(id);
    if (target) {
      target.style.display = 'block';
      if (id === 'mapView' && typeof map !== 'undefined') setTimeout(() => map.invalidateSize(), 120);
    }
    sidebarLinks.forEach(l => l.classList.remove('active'));
    const link = Array.from(sidebarLinks).find(l => l.getAttribute('href') === `#${id}`);
    if (link) link.classList.add('active');
  }
  if (sidebarLinks.length) {
    sidebarLinks.forEach(link => link.addEventListener('click', function(e) {
      e.preventDefault();
      const href = this.getAttribute('href') || '';
      const id = href.startsWith('#') ? href.substring(1) : href;
      if (!id) return;
      showSectionById(id);
      if (history && history.replaceState) history.replaceState(null, '', `#${id}`);
    }));
  }
  const initialHash = (location.hash || '').replace('#','') || 'searchRooms';
  showSectionById(initialHash);

  // Filters (placeholder)
  document.querySelectorAll('#searchForm input').forEach(input => {
    input.addEventListener('change', function(){ document.querySelectorAll('.room-card').forEach(c=>c.style.display='block'); });
    input.addEventListener('keyup', function(){ document.querySelectorAll('.room-card').forEach(c=>c.style.display='block'); });
  });

  // Map init (protected)
  let map;
  const markers = {};
  const mapEl = document.getElementById('map');
  if (mapEl) {
    try {
      map = L.map('map', { zoomControl: false }).setView([36.7538, 3.0588], 10);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '© OpenStreetMap contributors © CARTO', maxZoom: 19 }).addTo(map);
    } catch (e) {
      console.warn('Map init failed:', e);
    }
  }

  // Add markers safely
  <% (rooms || []).forEach(function(room) { %>
    <% if (room.lat != null && room.lng != null) { %>
      (function(){
        try {
          if (typeof L !== 'undefined' && map) {
            const icon = L.divIcon({ className: 'custom-map-marker', html: '<div class="marker-pin"><i class="fas fa-door-open"></i></div>', iconSize: [40,40], iconAnchor: [20,40], popupAnchor: [0,-40] });
            const m = L.marker([<%= room.lat %>, <%= room.lng %>], { icon }).bindPopup(`
              <div class="map-popup">
                <img src="<%= room.image %>" alt="<%= room.name %>">
                <div class="popup-content">
                  <h5><%= room.name %></h5>
                  <p class="popup-location"><i class="fas fa-map-marker-alt"></i> <%= room.wilaya %></p>
                  <p class="popup-price"><%= parseInt(room.price || 0) %> DA/jour</p>
                  <a href="/rooms/<%= room.id %>/book" class="popup-btn">Réserver</a>
                </div>
              </div>
            `, { className: 'custom-popup' }).addTo(map);
            markers['<%= room.id %>'] = m;
          }
        } catch (err) { console.warn('Marker error for room <%= room.id %>:', err); }
      })();
    <% } %>
  <% }); %>

  // Map/list interaction
    document.querySelectorAll('.map-room-item').forEach(item => {
    item.addEventListener('click', function() {
        const lat = parseFloat(this.dataset.lat), lng = parseFloat(this.dataset.lng), roomId = this.dataset.roomId;
        if (!isNaN(lat) && !isNaN(lng) && map) { map.setView([lat, lng], 15, { animate: true }); if (markers[roomId]) markers[roomId].openPopup(); }
        document.querySelectorAll('.map-room-item').forEach(i => i.classList.remove('active')); this.classList.add('active');
    });
    });

  document.getElementById('mapZoomIn')?.addEventListener('click', () => map && map.zoomIn());
  document.getElementById('mapZoomOut')?.addEventListener('click', () => map && map.zoomOut());
  document.getElementById('mapReset')?.addEventListener('click', () => map && map.setView([36.7538, 3.0588], 10));

  // Programmatic modal fallback (ensures modals open even if data-bs aren't processed)
    document.querySelectorAll('.btn-details, .quick-view-btn').forEach(btn => {
    btn.addEventListener('click', function (e) {
        const target = this.getAttribute('data-bs-target') || this.dataset.bsTarget;
        if (!target) return;
        const modalEl = document.querySelector(target);
        if (!modalEl) { console.warn('Modal not found for', target); return; }
        if (modalEl.parentNode !== document.body) document.body.appendChild(modalEl);
        try { bootstrap.Modal.getOrCreateInstance(modalEl).show(); } catch (err) { console.warn('Bootstrap modal API error:', err); }
    });
    });

  // Debug: detect ancestors with transform (can cut modal). Logs in console so you can act.
    document.querySelectorAll('.modal').forEach(modalEl => {
    let p = modalEl.parentNode;
    while (p && p !== document.body) {
        const cs = window.getComputedStyle(p);
        if (cs.transform && cs.transform !== 'none') console.warn('Ancestor with transform (may clip modal):', p, 'modal id:', modalEl.id);
        p = p.parentNode;
    }
    });

});
</script>

<!-- Quick styles to ensure modal/backdrop z-index is high -->
<style>
body > .modal { z-index: 1060 !important; }
.modal-backdrop { z-index: 1050 !important; }
.dashboard-wrapper, .dashboard-main { overflow: visible !important; }
</style>

<%- include('../partials/footer') %>