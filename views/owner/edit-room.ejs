<%- include('../partials/header') %>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h3>Modifier la salle</h3>
                </div>
                <div class="card-body">
                    <% if (typeof error !== 'undefined' && error) { %>
                        <div class="alert alert-danger">
                            <%= error %>
                        </div>
                    <% } %>
                    <form action="/owner/edit-room/<%= room.id %>" method="POST" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="name" class="form-label">Nom de la salle</label>
                            <input type="text" class="form-control" id="name" name="name" value="<%= room.name %>" required>
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="3" required><%= room.description %></textarea>
                        </div>

                       <div class="row">
  <div class="col-md-6 mb-3">
    <label for="capacity" class="form-label">Capacité (personnes)</label>
    <input type="number" class="form-control" id="capacity" name="capacity" value="<%= room.capacity %>" min="1" required>
  </div>
  <div class="col-md-6 mb-3">
    <label for="price" class="form-label">Prix par jour (DA)</label>
    <input type="number" class="form-control" id="price" name="price" value="<%= room.price %>" min="0" required>
  </div>
</div>

<div class="row">
  <div class="col-md-6 mb-3">
    <label for="location" class="form-label">Adresse / Lieu</label>
    <input type="text" class="form-control" id="location" name="location" value="<%= room.location || '' %>">
  </div>
  <div class="col-md-6 mb-3">
    <label for="wilaya" class="form-label">Wilaya</label>
    <input type="text" class="form-control" id="wilaya" name="wilaya" value="<%= room.wilaya || '' %>">
  </div>
</div>

<!-- Coordonnées GPS -->
<div class="mb-3">
    <label class="form-label">Localisation sur la carte</label>
    <p class="text-muted small">Cliquez sur la carte pour définir la position exacte de votre salle, ou saisissez manuellement les coordonnées</p>
    <div class="row">
        <div class="col-md-6 mb-3">
            <label for="lat" class="form-label">Latitude</label>
            <input type="text" class="form-control" id="lat" name="lat" value="<%= room.lat %>" placeholder="Ex: 36.7538" required>
        </div>
        <div class="col-md-6 mb-3">
            <label for="lng" class="form-label">Longitude</label>
            <input type="text" class="form-control" id="lng" name="lng" value="<%= room.lng %>" placeholder="Ex: 3.0588" required>
        </div>
    </div>
    <!-- Petite carte pour sélectionner la position -->
    <div id="location-map" style="height: 300px; border: 1px solid #ddd; border-radius: 8px;"></div>
</div>

                        <div class="mb-3">
                            <label for="image" class="form-label">Image de la salle</label>
                            <input type="file" class="form-control" id="image" name="image" accept="image/*">
                            <small class="form-text text-muted">Laissez vide pour garder l'image actuelle</small>
                            <div class="mt-2">
                                <img src="<%= room.image %>" alt="<%= room.name %>" class="img-thumbnail" style="max-height: 200px;">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Équipements disponibles</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="equipment" value="wifi" id="wifi"
                                    <%= room.equipment && room.equipment.includes('wifi') ? 'checked' : '' %>>
                                <label class="form-check-label" for="wifi">WiFi</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="equipment" value="projector" id="projector"
                                    <%= room.equipment && room.equipment.includes('projector') ? 'checked' : '' %>>
                                <label class="form-check-label" for="projector">Vidéoprojecteur</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="equipment" value="sound" id="sound"
                                    <%= room.equipment && room.equipment.includes('sound') ? 'checked' : '' %>>
                                <label class="form-check-label" for="sound">Système audio</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="equipment" value="whiteboard" id="whiteboard"
                                    <%= room.equipment && room.equipment.includes('whiteboard') ? 'checked' : '' %>>
                                <label class="form-check-label" for="whiteboard">Tableau blanc</label>
                            </div>
                        </div>

                        <div class="text-end">
                            <a href="/owner/dashboard" class="btn btn-secondary me-2" style="color: white !important;">Annuler</a>
                            <button type="submit" class="btn btn-primary">Enregistrer les modifications</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
// Initialisation de la carte pour la sélection de localisation
const defaultLat = <%= room.lat %>;
const defaultLng = <%= room.lng %>;
const locationMap = L.map('location-map').setView([defaultLat, defaultLng], 10);

// Tile layer
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    attribution: '© OpenStreetMap contributors © CARTO',
    maxZoom: 19
}).addTo(locationMap);

// Marqueur pour la position sélectionnée
let selectedMarker = L.marker([defaultLat, defaultLng]).addTo(locationMap)
    .bindPopup('Position actuelle<br>Lat: ' + defaultLat + '<br>Lng: ' + defaultLng)
    .openPopup();

// Gestionnaire de clic sur la carte
locationMap.on('click', function(e) {
    const lat = e.latlng.lat.toFixed(6);
    const lng = e.latlng.lng.toFixed(6);

    // Mettre à jour les champs
    document.getElementById('lat').value = lat;
    document.getElementById('lng').value = lng;

    // Déplacer le marqueur
    selectedMarker.setLatLng([lat, lng]);
    selectedMarker.bindPopup('Position sélectionnée<br>Lat: ' + lat + '<br>Lng: ' + lng).openPopup();
});

// Synchronisation des champs vers la carte
document.getElementById('lat').addEventListener('input', updateMapFromFields);
document.getElementById('lng').addEventListener('input', updateMapFromFields);

function updateMapFromFields() {
    const lat = parseFloat(document.getElementById('lat').value);
    const lng = parseFloat(document.getElementById('lng').value);
    
    if (!isNaN(lat) && !isNaN(lng)) {
        selectedMarker.setLatLng([lat, lng]);
        locationMap.setView([lat, lng], 15);
        selectedMarker.bindPopup('Position personnalisée<br>Lat: ' + lat + '<br>Lng: ' + lng).openPopup();
    }
}

// Log des données avant soumission
document.querySelector('form').addEventListener('submit', function(e) {
    const lat = document.getElementById('lat').value;
    const lng = document.getElementById('lng').value;
    console.log('CLIENT DEBUG: Soumission formulaire - lat:', lat, 'lng:', lng);
});
</script>

<%- include('../partials/footer') %>
